<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Cadastro de Pedido</title>
    <meta charset="UTF-8"/>
    <div id="status-container"></div>

    <script>
        let intervalId;

      function verificarStatus() {
          fetch('/statusBuscaProdutos')
              .then(response => response.json())
              .then(data => {
                  const statusContainer = document.getElementById('status-container');
                  if (data.status === 'pronto') {
                      statusContainer.textContent = 'Produtos estão prontos!';
                      carregarProdutos();
                      clearInterval(intervalId);
                  } else {
                      statusContainer.textContent = 'Ainda buscando produtos...';
                  }
              })
              .catch(error => {
                  console.error('Erro ao verificar status:', error);
              });
      }

      let produtosList = [];

      function mostrarAlerta() {
          alert("O pedido está sendo processado. Por favor, aguarde.");
          return true;
      }

      function carregarProdutos() {
          fetch('/getProdutos')
              .then(response => response.json())
              .then(data => {
                  produtosList = data;
                  const produtosContainer = document.getElementById('produtos-container');
                  produtosContainer.innerHTML = '';

                  data.forEach(produto => {
                      const produtoDiv = document.createElement('div');
                      produtoDiv.innerHTML = `
                          <input type="checkbox" name="produtos" value="${produto.id}" />
                          <label>${produto.nome} - ${produto.descricao} - ${produto.preco}</label>
                          <br/>
                      `;
                      produtosContainer.appendChild(produtoDiv);
                  });
              })
              .catch(error => {
                  console.error('Erro ao obter produtos:', error);
              });
      }

      function enviarPedido(event) {
          event.preventDefault();

          const checkboxes = document.querySelectorAll('input[name="produtos"]:checked');
          const produtosSelecionados = Array.from(checkboxes).map(checkbox => {
              return produtosList.find(produto => produto.id == checkbox.value);
          });

          fetch('/cadastrarPedido', {
              method: 'POST',
              headers: {
                  'Content-Type': 'application/json',
              },
              body: JSON.stringify(produtosSelecionados)
          })
          .then(response => {
              if (response.ok) {
                  alert('Pedido enviado com sucesso!');
              } else {
                  alert('Erro ao enviar o pedido.');
              }
          })
          .catch(error => {
              console.error('Erro ao enviar pedido:', error);
          });
      }

      window.onload = function() {
          carregarProdutos();
      };

       intervalId = setInterval(verificarStatus, 2000);
    </script>
</head>
<body>
<h1>Cadastro de Pedido</h1>

<form id="pedido-form" onsubmit="enviarPedido(event)">
    <div id="produtos-container"></div>
    <button type="submit">Finalizar Pedido</button>
</form>

</body>
</html>
